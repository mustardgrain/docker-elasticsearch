#!/bin/bash -e

if [ "$USE_UNICAST" != "" ] ; then
    if [ ! -f $ELASTICSEARCH_HOME/.esconfig ]; then
        if [ "$UNICAST_HOST" = "" ] ; then
            UNICAST_HOST=$(/sbin/ifconfig eth0 | grep 'inet addr' | cut -d: -f2 | awk '{print $1}')
        fi

        CONF_FILE=$ELASTICSEARCH_HOME/config/elasticsearch.yml

        if [ "$MASTER" = "" ] ; then
            MASTER=false
        fi

        echo "node.master: $MASTER" >> $CONF_FILE
        echo "discovery.zen.minimum_master_nodes: $NUM_MASTERS" >> $CONF_FILE
        echo "discovery.zen.ping.multicast.enabled: false" >> $CONF_FILE
        echo "discovery.zen.ping.unicast.hosts: [\"$UNICAST_HOST\"]" >> $CONF_FILE

        $ELASTICSEARCH_HOME/bin/plugin -install mobz/elasticsearch-head

        touch $ELASTICSEARCH_HOME/.esconfig
    fi
fi

$ELASTICSEARCH_HOME/bin/elasticsearch
